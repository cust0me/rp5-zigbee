services:
  rabbitmq:
    image: rabbitmq:4.1-management
    ports:
      - "5672:5672"
      - "15672:15672"
      - "1883:1883"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    command: >
      bash -c "rabbitmq-plugins enable rabbitmq_mqtt"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt
    restart: unless-stopped
    ports:
      - "8080:8080"
    devices:
      - "${ZIGBEE_ADAPTER}:/dev/ttyACM0"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./zigbee2mqtt/configuration.yaml:/app/data/configuration.yaml:ro
      - ./volumes/zigbee2mqtt-data:/app/data

  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_ADMIN_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_ADMIN_TOKEN}
    volumes:
      - ./volumes/influxdb-data:/var/lib/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # influx-init:
  #   image: influxdb:2.7
  #   depends_on:
  #     influxdb:
  #       condition: service_healthy
  #   command: >
  #     sh -c "
  #     until curl -s http://influxdb:8086/health | grep 'pass'; do sleep 2; done &&
  #     sleep 10 &&
  #     echo 'Creating API token using influx CLI...' &&
  #     influx auth create \\
  #       --read-buckets \\
  #       --write-buckets \\
  #       --org ${INFLUXDB_ORG} \\
  #       --host http://influxdb:8086 \\
  #       --token ${INFLUXDB_ADMIN_TOKEN} \\
  #       --json > /init/token.txt &&
  #     echo 'Token created successfully' &&
  #     cat /init/token.txt
  #     "
  #   volumes:
  #     - ./volumes/influx-token:/init

  # influx-token-extract:
  #   image: python:3.11-alpine
  #   depends_on:
  #     influx-init:
  #       condition: service_completed_successfully
  #   volumes:
  #     - ./volumes/influx-token:/init
  #     - ./.env:/work/.env
  #     - ./extract_token.py:/extract_token.py:ro
  #   entrypoint: python /extract_token.py

  api:
    image: ghcr.io/cust0me/rp5-zigbee-api:master
    ports:
      - "${API_PORT}:8080"
    depends_on:
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      # influx-token-extract:
      #   condition: service_completed_successfully
    environment:
      MqttBroker__Host: rabbitmq
      MqttBroker__Port: 1883
      MqttBroker__UseTls: "false"
      MqttBroker__ClientId: "rp5-zigbee-api"
      MqttBroker__Username: ${RABBITMQ_USER}
      MqttBroker__Password: ${RABBITMQ_PASSWORD}
      MqttBroker__TelemetryTopics: "[\"zigbee2mqtt/+\"]"
      InfluxDB__Host: http://influxdb:8086
      InfluxDB__Token: ${INFLUXDB_ADMIN_TOKEN}
      InfluxDB__OrgId: ${INFLUXDB_ORG}
      InfluxDB__Bucket: ${INFLUXDB_BUCKET}

  # frontend:
  #   image: ghcr.io/cust0me/rp5-zigbee-web
  #   environment:
  #     API_URL: http://api:${API_PORT}
  #     FRONTEND_PORT: ${FRONTEND_PORT}
  #   ports:
  #     - "${FRONTEND_PORT}:8080"

volumes:
  influxdb-data:
  # influx-token: